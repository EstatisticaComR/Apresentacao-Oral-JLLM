---
title: 'Mapa da Criminalidade: Correios'
author: "Luciane Ferreira Alcoforado"
date: "8 de julho de 2016"
#output: html_document
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
#install.packages("leaflet")
#install.packages("data.table")
#install.packages("tidyverse")
library(leaflet)
library(data.table)
library(tidyverse)
dados <- read.csv(file="http://bit.ly/bancodedadosCorreios", encoding = "UTF-8")
```

```{r, eval=F}
dados <- read.csv(file="base_de_dados_em_sigilo")
```

```{r}
as_tibble(dados)
summary(dados)

#Quais variaveis possuem dados em branco e quantas celulas em branco temos por variavel:
sapply(dados,function(x) sum(is.na(x)))
```

Como os registros estao distribuidos por ano:
```{r, eval=F}
#Separando por ano
dAnos <- dados %>% count(ano) 
ano <- dAnos %>% pull(ano) %>% as.factor()
freq_ano <- dAnos %>% pull(n) #pull seleciona coluna e retorna como vetor

data.frame(ano, freq_ano, perc=round(100*freq_ano/sum(freq_ano),1))
p1 <- ggplot(data=data.frame(ano,freq_ano),aes(x=ano, y=freq_ano, fill=as.factor(freq_ano)))+
  geom_bar(stat="identity", width=0.5,position="dodge")+
  labs(x="ano", y= "frequencia", title="Número de Assaltos aos Correios") 
p1
```

```{r}
#Separando por dia da semana
dados_sem1 <- na.omit(dados %>% count(dia.semana))

dia <- c("1.Seg","2.Ter", "3.Qua", "4.Qui", "5.Sex", "6.Sab","7.Dom")
freq_dias <- c(dados_sem1 %>% pull(n))
data.frame(dia,freq_dias,perc=round(100*freq_dias/sum(freq_dias),1))

p2 <- ggplot(data=data.frame(dia,freq_dias),aes(x=dia, y=freq_dias, fill=as.factor(freq_dias)))+
  geom_bar(stat="identity", width=0.5,position="dodge")+
  labs(x="dia da semana", y= "frequencia", title="Numero de Assaltos aos Correios") 
p2

#Selecionando a coluna dia.semana e omitindo os dados faltantes
#ind=is.na(dados$dia.semana)
#dados1=dados[ind==FALSE,]
dados_sem2 <- na.omit(dados %>% select(dia.semana))

#criando correspondencia entre dia da semana e o nome dos dias:
sem <- 1:7
nome.sem <- c("1.Segunda", "2.Terça", "3.Quarta", "4.Quinta", "5.Sexta", "6.Sábado", "7.Domingo")
names(sem) <- nome.sem
sem
dia.sem.name=names(sem)[dados_sem2$dia.semana]
dados1=data.frame(dados1,dia.sem.name)
p3=ggplot(data=dados1,aes(x=as.factor(ano),fill=dia.sem.name))+
  geom_bar(stat="count", width=0.5,position="dodge")+
  labs(x="dia da semana", y= "frequencia", title="Numero de Assaltos aos Correios") 
p3
```

Agora vamos utilizar o pacote data.table que foi concebido para facilitar a tabulacao dos dados. 
Neste pacote podemos acessar rapidamente um subconjunto de dados, agrupa-los, atualiza-los, produzir tabelas.
Para instalar o pacote use: install.packages("data.table")

```{r}
dt=data.table(dados)

#Numero de linhas
dt[,.N]
#Variaveis do banco de dados
names(dt)
#Quantos niveis distintos em cada variavel:
sapply(dt,function(x) length(unique(x)))
#Quantos assaltos por município?
dt[,.N,by=Mun][order(-N)]
#Quantos assaltos por bairro?
dt[,.N,by=Bairro][order(-N)]
#Os seis bairros com maior ocorrencia de assalto
head(dt[,.N,by=Bairro][order(-N)])
#Criar um codigo de area e listar as areas com maior ocorrencia (ex. CEP)
dt[,.N,by=CEP][order(-N)]
#Simulando as ocorrencias de um universo de 1000 assaltos por amostragem sobre os dados
dt[sample(1:.N,1000, replace=T), .(mean=mean(.N)), by=Bairro][order(-mean)]
#Contagem de assaltos por mês
na.omit(dt[,.N,by=substr(mês,1,12)][order(-N)])
#Contagem de assaltos por dia da semana
na.omit(dt[,.N,by=substr(dia.semana,1,7)][order(-N)])
#Contagem de assaltos por data
na.omit(dt[,.N,by=substr(DT.Assalto,1,10)][order(-N)])
#Contagem de assaltos por hora
na.omit(dt[,.N,by=substr(H.Assalto,1,24)][order(-N)])
```

```{r}
#Quantos bairros distintos?
dt %>% select(Bairro) %>% distinct() %>% nrow()

#Quantas ocorrencias em cada Bairro?
#modo1
dt %>% group_by(Bairro) %>% summarize(ocorrencia=n()) %>% arrange(desc(ocorrencia))
#modo2
dt %>% count(Bairro,sort=TRUE)
```

```{r, eval=F}
require(RgoogleMaps)

caixa <- qbbox(lat=dados$Latitude/10^6, lon=dados$Longitude/10^6)
map <- GetMap.bbox(caixa$lonR, caixa$latR, destfile = "r_outtile3.png", maptype="satellite")
PlotOnStaticMap(map, lat=dados$Latitude/10^6, lon=dados$Longitude/10^6,  pch=20, col=rgb(1,0,0,0.7), add=F)
map <- GetMap.bbox(caixa$lonR, caixa$latR, destfile = "r_outtile3.png", maptype="mobile")
PlotOnStaticMap(map, lat=dados$Latitude/10^6, lon=dados$Longitude/10^6,  pch=20, col=rgb(1,0,0,0.7), add=F)
IdentifyPoints(map, n = 2, verbose = 0) #identifica pontos no mapa, n=2 ? o n?mero de pontos

#mapdata<-read.csv("average_home_insurance.csv",header=T)
#install.packages("ggmap")
#install.packages("mapproj")
library(ggmap)
library(mapproj)
mapdata=data.frame(longitude=c(-43.207778),latitude=c( -22.902778), Home.Insurance=c(200))
map <- get_map(location = 'BR', zoom = 4)
ggmap(map)
TC <-ggmap(map)+geom_point(data=mapdata,alpha = .7, aes(x=longitude, y=latitude,size =Home.Insurance),color='red')+ggtitle("Average Home Insurance By City($)")
TC
```

